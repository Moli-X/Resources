# 更新日期：2024-12-20

name: Fork & Edit

on:
  workflow_dispatch:
  schedule:
    - cron: "30 0,12 * * *"

permissions:
  actions: write  
  contents: write  



jobs:
  ForkRepository:
    runs-on: ubuntu-latest
    env:
      TZ: 'Asia/Shanghai'
    
    steps: 
    - name: 验证目标存储库
      uses: actions/checkout@v4.2.2
      with:
        repository: Moli-X/Resources
        path: Resources-repo
        token: ${{ secrets.GITHUB_TOKEN }}  


    
###### Fork

    - name: 复刻原始文件
      run: |
        mkdir -p Resources/.github/Record
        curl -L -o Resources-repo/.github/Record/Build.yml "https://github.com/Repcz/Tool/raw/X/.github/workflows/Build.yml"
        curl -L -o Resources-repo/.github/Record/ClearCommits.yml "https://github.com/Repcz/Tool/raw/X/.github/workflows/ClearCommits.yml"

    - name: 规则下载
      run: |

        # 检查是否在正确的仓库中
        repo_name=$(basename "$GITHUB_REPOSITORY")
        if [[ "$repo_name" == "Resources" ]]; then
            echo "Running in Resources repository"
            # 创建目标文件夹
            mkdir -p Resources-repo/QuantumultX/Ruleset
            # 定义下载规则的函数
            download_rules() {
                local output_file="$1"
                shift
                local urls=("$@")
                > "$output_file"
                for url in "${urls[@]}"; do
                    echo "Downloading: $url"
                    curl -f -L "$url" >> "$output_file" || { echo "Download Failed: $url"; exit 1; }
                    echo "" >> "$output_file"
                done
            }

            # 合并广告规则
            download_rules "Tool-repo/QuantumultX/Ruleset/Reject.list" \
                "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Advertising.list" \
                "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Malicious.list" \
                "https://raw.githubusercontent.com/ConnersHua/RuleGo/master/Surge/Ruleset/Extra/Reject/Tracking.list" \
                "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/BanEasyListChina.list"
            
            # 合并 SukkaW 广告规则
            download_rules "Resources-repo/QuantumultX/Ruleset/Ads_SukkaW.list" \
                "https://ruleset.skk.moe/List/domainset/reject.conf" \
                "https://ruleset.skk.moe/List/non_ip/reject.conf"
            
            # 合并 SukkaW CDN 规则
            download_rules "Resources-repo/QuantumultX/Ruleset/CDN.list" \
                "https://ruleset.skk.moe/List/domainset/cdn.conf" \
                "https://ruleset.skk.moe/List/non_ip/cdn.conf"
            
            # 合并 GFW 规则
            download_rules "Resources-repo/QuantumultX/Ruleset/ProxyGFW.list" \
                "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/ProxyGFWlist.list" \
                "https://raw.githubusercontent.com/Loyalsoldier/surge-rules/release/ruleset/gfw.txt"

            # 定义关联数组（使用简洁的键名）
            declare -A files=(
                # 苹果
                ["APNs"]="https://kelee.one/Tool/Loon/Rule/ApplePushNotificationService.list"
                ["Apple"]="https://raw.githubusercontent.com/NobyDa/Script/master/Surge/Apple.list"
                ["AppleProxy"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppleProxy/AppleProxy.list"
                ["AppStore"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/AppStore/AppStore.list"  
                ["AppleID"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/AppleID/AppleID.list" 
                ["TestFlight"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/TestFlight/TestFlight.list" 
                # AI               
                ["OpenAI"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/OpenAI/OpenAI.list"
                ["Claude"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/Claude/Claude.list"
                ["AI"]="https://ruleset.skk.moe/List/non_ip/ai.conf"
                # 社交媒体
                ["Twitter"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Twitter.list"
                ["Instagram"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Instagram.list"
                ["Spotify"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Spotify/Spotify.list"
                ["Telegram"]="https://github.com/Repcz/Tool/raw/X/Surge/Custom/Telegram.list" 
                ["Facebook"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/Facebook/Facebook.list" 
                # 谷歌
                ["YouTube"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/YouTube.list"
                ["Google"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Google.list"
                ["Gemini"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/Gemini/Gemini.list"
                # 微软
                ["GitHub"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/GitHub/GitHub.list"
                ["OneDrive"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/OneDrive.list"
                ["Microsoft"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Microsoft.list"
                ["Bing"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/Bing/Bing.list"
                # 极狐
                ["GitLab"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/GitLab/GitLab.list"
                # Notion
                ["Notion"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/Notion/Notion.list"
                # 甲骨文
                ["Oracle"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Oracle/Oracle.list"
                # 流媒体
                ["AutoBilibili"]="https://raw.githubusercontent.com/NobyDa/Script/master/Surge/Bilibili.list"
                ["DouYin"]="https://github.com/blackmatrix7/ios_rule_script/raw/master/rule/Clash/DouYin/DouYin.list"
                ["TikTok"]="https://kelee.one/Tool/Loon/Rule/TikTok.list"
                ["Netflix"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Netflix.list"
                ["HBO"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/HBO/HBO.list"
                ["Disney"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/Disney/Disney.list"
                ["PrimeVideo"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/PrimeVideo/PrimeVideo.list"
                # PayPal
                ["PayPal"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/PayPal/PayPal.list"
                # Cloudflare
                ["Cloudflare"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Cloudflare/Cloudflare.list"
                # 游戏
                ["Steam"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Steam/Steam.list"
                ["Epic"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Epic/Epic.list"
                ["Game"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Surge/Game/Game.list"
                # 下载CDN
                ["DownloadCDN_Global"]="https://kelee.one/Tool/Loon/Rule/InternationalDownloadCDN.list"
                ["DownloadCDN_CN"]="https://kelee.one/Tool/Loon/Rule/ChinaDownloadCDN.list"
                # 远程软件 
                ["TeamViewer"]="https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Loon/TeamViewer/TeamViewer.list"
                # 国内规则 
                ["Bilibili"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/Ruleset/Bilibili.list"
                ["WeChat"]="https://raw.githubusercontent.com/NobyDa/Script/master/Surge/WeChat.list"
                ["ChinaASN"]="https://raw.githubusercontent.com/VirgilClyne/GetSomeFries/main/ruleset/ASN.China.list"
                ["ChinaDomain"]="https://ruleset.skk.moe/List/non_ip/domestic.conf"
                ["Lan"]="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/LocalAreaNetwork.list"
                # 广告规则
                ["HTTPDNS.Block"]="https://raw.githubusercontent.com/VirgilClyne/GetSomeFries/main/ruleset/HTTPDNS.Block.list"
                ["Ads_limbopro"]="https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/Surge/rule/Adblock4limbo_surge.list"
                ["Ads_EasyListChina"]="https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easylistchina_surge.list"
                ["Ads_EasyListPrivacy"]="https://raw.githubusercontent.com/limbopro/Adblock4limbo/main/rule/Surge/easyprivacy_surge.list"
                ["Ads_Dlerio"]="https://raw.githubusercontent.com/dler-io/Rules/main/Surge/Surge%203/Provider/AdBlock.list"
                ["Ads_AWAvenue"]="https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Surge.list"
                ["Anti-Ad"]="https://github.com/privacy-protection-tools/anti-AD/raw/master/anti-ad-surge.txt"
                # 自定义规则
                ["Taida"]="https://github.com/Moli-X/Resources/raw/main/Clash/Rules/Taida.list"
                ["Trendmicro"]="https://github.com/Moli-X/Resources/raw/main/Clash/Rules/Trendmicro.list"
                ["VSCode"]="https://github.com/Moli-X/Resources/raw/main/Clash/Rules/VSCode.list"
            )
        
            # 下载文件
            for filename in "${!files[@]}"; do
                echo "Downloading: ${files[$filename]}"
                curl -A "Surge iOS/3367" -f -L -o "Tool-repo/Ruleset/$filename.list" "${files[$filename]}" || { echo "Download Failed: ${files[$filename]}"; exit 1; }
            done
        
            echo "Files downloaded successfully."
        else
            echo "Unknown repository. Please run this script in the Tool repository."
            exit 1
        fi


    - name: Source创建
      run: |
        for file in Resources-repo/QuantumultX/Ruleset/*.list ; do
          if [ -f "$file" ]; then
            sed -i -E '/^IP-CIDR,/!{/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+/s/^/IP-CIDR,/}' "$file"
            sed -i -E '/^IP-CIDR6,/!{/^[a-fA-F0-9]+:|([a-fA-F0-9]+:+)+[a-fA-F0-9]+\/[0-9]+/s/^/IP-CIDR6,/}' "$file"
            awk '
            /^DOMAIN,/         { print "0 " $0; next }
            /^DOMAIN-SUFFIX,/  { print "1 " $0; next }
            /^DOMAIN-KEYWORD,/ { print "2 " $0; next }
            /^DOMAIN-WILDCARD,/{ print "3 " $0; next }
            /^IP-CIDR,/        { print "4 " $0; next }
            /^IP-CIDR6,/       { print "5 " $0; next }
            /^IP-ASN,/         { print "6 " $0; next }
            /^PROCESS-NAME,/   { print "7 " $0; next }
            /^URL-REGEX,/      { print "8 " $0; next }
            /^USER-AGENT,/     { print "9 " $0; next }
            /^GEOIP,/          { print "10 " $0; next }
            /^AND,/            { print "11 " $0; next }
            /^OR,/             { print "12 " $0; next }
            /^NOT,/            { print "13 " $0; next }
            /^DEST-PORT,/      { print "14 " $0; next }
                               { print "15 " $0; next }
            ' "$file" | sort -k1,1n -k2,2 | cut -d' ' -f2- > "$file.sorted" && mv "$file.sorted" "$file"
            awk '!seen[tolower($0)]++' "$file" > temp && mv temp "$file"
          else
            echo "$file not found."
          fi
        done


    - name: Source整理
      run: |
        for file in Resources-repo/QuantumultX/Ruleset/*.list ; do
          if [ -f "$file" ]; then
            sed -i -E '/^IP-CIDR,/!{/^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+\/[0-9]+/s/^/IP-CIDR,/}' "$file"
            sed -i -E '/^IP-CIDR6,/!{/^[a-fA-F0-9]+:|([a-fA-F0-9]+:+)+[a-fA-F0-9]+\/[0-9]+/s/^/IP-CIDR6,/}' "$file"
            awk '
            /^DOMAIN,/         { print "0 " $0; next }
            /^DOMAIN-SUFFIX,/  { print "1 " $0; next }
            /^DOMAIN-KEYWORD,/ { print "2 " $0; next }
            /^DOMAIN-WILDCARD,/{ print "3 " $0; next }
            /^IP-CIDR,/        { print "4 " $0; next }
            /^IP-CIDR6,/       { print "5 " $0; next }
            /^IP-ASN,/         { print "6 " $0; next }
            /^PROCESS-NAME,/   { print "7 " $0; next }
            /^URL-REGEX,/      { print "8 " $0; next }
            /^USER-AGENT,/     { print "9 " $0; next }
            /^GEOIP,/          { print "10 " $0; next }
            /^AND,/            { print "11 " $0; next }
            /^OR,/             { print "12 " $0; next }
            /^NOT,/            { print "13 " $0; next }
            /^DEST-PORT,/      { print "14 " $0; next }
                               { print "15 " $0; next }
            ' "$file" | sort -k1,1n -k2,2 | cut -d' ' -f2- > "$file.sorted" && mv "$file.sorted" "$file"
            awk '!seen[tolower($0)]++' "$file" > temp && mv temp "$file"
          else
            echo "$file not found."
          fi
        done

    - name: Copy文件
      run: |
        rm -rf Resources-repo/{Clash,Egern,Loon,QuantumultX,Shadowrocket,Stash,Surge}/Rules
        mkdir -p Resources-repo/{Clash,Egern,Loon,QuantumultX,Shadowrocket,Stash,Surge}/Rules
        for file in Resources-repo/Ruleset/*.list; do
          filename=$(basename "$file")
          for dir in Clash Loon QuantumultX Shadowrocket Stash Surge; do
            cp "$file" "Resources-repo/$dir/Rules/$filename"
          done
          # 复制到Egern文件夹, 并将后缀改为.yaml
          cp "$file" "Resources-repo/Egern/Rules/${filename%.*}.yaml"
        done
        echo "Files copied successfully."

###### Loon
    - name: Loon
      run: |
        for file in Resources-repo/Loon/Rules/*.list; do
          if [ -f "$file" ]; then
            sed -i -e '/^PROCESS-NAME/d' "$file"
            file_names=$(basename "$file" .list)
            line_count=$(wc -l < "$file")
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            sed -i '2a\\' "$file"
          else
            echo "$file not found."
          fi
        done


    - name: 批量复刻LOON模块
      run: |
        mkdir -p Resources-repo/Loon/Plugin

        
        # 定义插件及其原链接
        declare -A plugins=(
            [Spotify]="https://github.com/DualSubs/Spotify/releases/latest/download/DualSubs.Spotify.plugin"
            [Boxjs]="https://github.com/chavyleung/scripts/raw/master/box/rewrite/boxjs.rewrite.loon.plugin"
            [General]="https://raw.githubusercontent.com/VirgilClyne/GetSomeFries/main/plugin/General.plugin"
            [QuickSearch]="https://github.com/Moli-X/Resources/raw/main/Loon/Search.plugin"
            [HTTPDNS.Block]="https://raw.githubusercontent.com/VirgilClyne/GetSomeFries/main/plugin/HTTPDNS.Block.plugin"
            [DNS]="https://raw.githubusercontent.com/VirgilClyne/GetSomeFries/main/plugin/DNS.plugin"
            [Script-Hub]="https://raw.githubusercontent.com/Script-Hub-Org/Script-Hub/main/modules/script-hub.loon.plugin"
            [sxmd_sign]="https://raw.githubusercontent.com/bgvioletsky/ios_rule/main/Loon/plugin/sxmd_sign.plugin"
            [BiliBiliDailyBonus]="https://raw.githubusercontent.com/ClydeTime/BiliBili/master/modules/BiliBiliDailyBonus.plugin"
            [DualSubs.YouTube]="https://github.com/DualSubs/YouTube/releases/latest/download/DualSubs.YouTube.plugin"
            [BlockAdvertisers]="https://kelee.one/Tool/Loon/Lpx/BlockAdvertisers.lpx"
            [Remove_ads_by_keli]="https://kelee.one/Tool/Loon/Lpx/Remove_ads_by_keli.lpx"
            [Cainiao_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Cainiao_remove_ads.lpx"
            [Himalaya_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Himalaya_remove_ads.lpx"
            [Tieba_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Tieba_remove_ads.lpx"
            [YouTube_remove_ads]="https://kelee.one/Tool/Loon/Lpx/YouTube_remove_ads.lpx"
            [Weibo_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Weibo_remove_ads.lpx"
            [Bilibili_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Bilibili_remove_ads.lpx"
            [Weibo_intl_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Weibo_intl_remove_ads.lpx"
            [Baidu_input_method_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Baidu_input_method_remove_ads.lpx"
            [Zhihu_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Zhihu_remove_ads.lpx"
            [NeteaseCloudMusic_remove_ads]="https://kelee.one/Tool/Loon/Lpx/NeteaseCloudMusic_remove_ads.lpx"
            [CoolApk_remove_ads]="https://kelee.one/Tool/Loon/Lpx/CoolApk_remove_ads.lpx"
            [smzdm_remove_ads]="https://kelee.one/Tool/Loon/Lpx/smzdm_remove_ads.lpx"
            [RedPaper_remove_ads]="https://kelee.one/Tool/Loon/Lpx/RedPaper_remove_ads.lpx"
            [Weixin_Official_Accounts_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Weixin_Official_Accounts_remove_ads.lpx"
            [QQMusic_remove_ads]="https://kelee.one/Tool/Loon/Lpx/QQMusic_remove_ads.lpx"
            [Daily_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Daily_remove_ads.lpx"
            [IThome_remove_ads]="https://kelee.one/Tool/Loon/Lpx/IThome_remove_ads.lpx"
            [BaiduSearchWebpage_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BaiduSearchWebpage_remove_ads.lpx"
            [BaiduNetDisk_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BaiduNetDisk_remove_ads.lpx"
            [TubeMax_remove_ads]="https://kelee.one/Tool/Loon/Lpx/TubeMax_remove_ads.lpx"
            [Amap_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Amap_remove_ads.lpx"
            [WexinMiniPrograms_Remove_ads]="https://kelee.one/Tool/Loon/Lpx/WexinMiniPrograms_Remove_ads.lpx"
            [QiDian_remove_ads]="https://kelee.one/Tool/Loon/Lpx/QiDian_remove_ads.lpx"
            [AliYunDrive_remove_ads]="https://kelee.one/Tool/Loon/Lpx/AliYunDrive_remove_ads.lpx"
            [iQiYi_Video_remove_ads]="https://kelee.one/Tool/Loon/Lpx/iQiYi_Video_remove_ads.lpx"
            [DragonRead_remove_ads]="https://kelee.one/Tool/Loon/Lpx/DragonRead_remove_ads.lpx"
            [YouKu_Video_remove_ads]="https://kelee.one/Tool/Loon/Lpx/YouKu_Video_remove_ads.lpx"
            [BabyTree_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BabyTree_remove_ads.lpx"
            [Tencent_Video_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Tencent_Video_remove_ads.lpx"
            [CaixinMedia_remove_ads]="https://kelee.one/Tool/Loon/Lpx/CaixinMedia_remove_ads.lpx"
            [Mango_Viedo_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Mango_Viedo_remove_ads.lpx"
            [Umetrip_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Umetrip_remove_ads.lpx"
            [JD_remove_ads]="https://kelee.one/Tool/Loon/Lpx/JD_remove_ads.lpx"
            [PiPiXia_remove_ads]="https://kelee.one/Tool/Loon/Lpx/PiPiXia_remove_ads.lpx"
            [Taobao_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Taobao_remove_ads.lpx"
            [NeteaseNews_remove_ads]="https://kelee.one/Tool/Loon/Lpx/NeteaseNews_remove_ads.lpx"
            [12306_remove_ads]="https://kelee.one/Tool/Loon/Lpx/12306_remove_ads.lpx"
            [Reddit_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Reddit_remove_ads.lpx"
            [Soul_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Soul_remove_ads.lpx"
            [QQKSong_remove_ads]="https://kelee.one/Tool/Loon/Lpx/QQKSong_remove_ads.lpx"
            [mobileClouds_remove_ads]="https://kelee.one/Tool/Loon/Lpx/mobileClouds_remove_ads.lpx"
            [PICC_Insurance_remove_ads]="https://kelee.one/Tool/Loon/Lpx/PICC_Insurance_remove_ads.lpx"
            [Spotify_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Spotify_remove_ads.lpx"
            [SevenCat_remove_ads]="https://kelee.one/Tool/Loon/Lpx/SevenCat_remove_ads.lpx"
            [HUPU_remove_ads]="https://kelee.one/Tool/Loon/Lpx/HUPU_remove_ads.lpx"
            [GaoDing_remove_ads]="https://kelee.one/Tool/Loon/Lpx/GaoDing_remove_ads.lpx"
            [PuPuMall_remove_ads]="https://kelee.one/Tool/Loon/Lpx/PuPuMall_remove_ads.lpx"
            [DiDi_remove_ads]="https://kelee.one/Tool/Loon/Lpx/DiDi_remove_ads.lpx"
            [Aiinquiry_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Aiinquiry_remove_ads.lpx"
            [QiXinBao_remove_ads]="https://kelee.one/Tool/Loon/Lpx/QiXinBao_remove_ads.lpx"
            [ZhuanZhuan_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ZhuanZhuan_remove_ads.lpx"
            [RiskBird_remove_ads]="https://kelee.one/Tool/Loon/Lpx/RiskBird_remove_ads.lpx"
            [iMaiCai_remove_ads]="https://kelee.one/Tool/Loon/Lpx/iMaiCai_remove_ads.lpx"
            [ZuiYou_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ZuiYou_remove_ads.lpx"
            [MailMaster_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MailMaster_remove_ads.lpx"
            [MiaoRead_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MiaoRead_remove_ads.lpx"
            [SafetyHome_remove_ads]="https://kelee.one/Tool/Loon/Lpx/SafetyHome_remove_ads.lpx"
            [360SmartCamera_remove_ads]="https://kelee.one/Tool/Loon/Lpx/360SmartCamera_remove_ads.lpx"
            [VideoGo_remove_ads]="https://kelee.one/Tool/Loon/Lpx/VideoGo_remove_ads.lpx"
            [FlyerTea_remove_ads]="https://kelee.one/Tool/Loon/Lpx/FlyerTea_remove_ads.lpx"
            [ShouYinTongMerchant_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ShouYinTongMerchant_remove_ads.lpx"
            [FenBi_remove_ads]="https://kelee.one/Tool/Loon/Lpx/FenBi_remove_ads.lpx"
            [TV_Assistant_remove_ads]="https://kelee.one/Tool/Loon/Lpx/TV_Assistant_remove_ads.lpx"
            [XiaoHeiHe_remove_ads]="https://kelee.one/Tool/Loon/Lpx/XiaoHeiHe_remove_ads.lpx"
            [Snowball_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Snowball_remove_ads.lpx"
            [KingdeeMyMoney_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KingdeeMyMoney_remove_ads.lpx"
            [XunLei_remove_ads]="https://kelee.one/Tool/Loon/Lpx/XunLei_remove_ads.lpx"
            [ShuQiCenterReader_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ShuQiCenterReader_remove_ads.lpx"
            [QuarkBrowser_remove_ads]="https://kelee.one/Tool/Loon/Lpx/QuarkBrowser_remove_ads.lpx"
            [JiaXiaoDrive_remove_ads]="https://kelee.one/Tool/Loon/Lpx/JiaXiaoDrive_remove_ads.lpx"
            [JiaKaoBaoDian_remove_ads]="https://kelee.one/Tool/Loon/Lpx/JiaKaoBaoDian_remove_ads.lpx"
            [DuiTang_remove_ads]="https://kelee.one/Tool/Loon/Lpx/DuiTang_remove_ads.lpx"
            [AutoHome_remove_ads]="https://kelee.one/Tool/Loon/Lpx/AutoHome_remove_ads.lpx"
            [KuGou_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KuGou_remove_ads.lpx"
            [Kuwo_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Kuwo_remove_ads.lpx"
            [DubbingShow_remove_ads]="https://kelee.one/Tool/Loon/Lpx/DubbingShow_remove_ads.lpx"
            [MKZ_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MKZ_remove_ads.lpx"
            [KuaiKanComic_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KuaiKanComic_remove_ads.lpx"
            [BiliComic_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BiliComic_remove_ads.lpx"
            [XFuse_remove_ads]="https://kelee.one/Tool/Loon/Lpx/XFuse_remove_ads.lpx"
            [ColorfulClouds_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ColorfulClouds_remove_ads.lpx"
            [Uki_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Uki_remove_ads.lpx"
            [Douyu_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Douyu_remove_ads.lpx"
            [GuideRank_remove_ads]="https://kelee.one/Tool/Loon/Lpx/GuideRank_remove_ads.lpx"
            [FleaMarket_remove_ads]="https://kelee.one/Tool/Loon/Lpx/FleaMarket_remove_ads.lpx"
            [PinDuoDuo_remove_ads]="https://kelee.one/Tool/Loon/Lpx/PinDuoDuo_remove_ads.lpx"
            [CatEarFM_remove_ads]="https://kelee.one/Tool/Loon/Lpx/CatEarFM_remove_ads.lpx"
            [XiaoCan_remove_ads]="https://kelee.one/Tool/Loon/Lpx/XiaoCan_remove_ads.lpx"
            [BooHee_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BooHee_remove_ads.lpx"
            [MaiMai_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MaiMai_remove_ads.lpx"
            [YoudaoDict_remove_ads]="https://kelee.one/Tool/Loon/Lpx/YoudaoDict_remove_ads.lpx"
            [MeiTu_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MeiTu_remove_ads.lpx"
            [555DY_remove_ads]="https://kelee.one/Tool/Loon/Lpx/555DY_remove_ads.lpx"
            [SeasunJX3_remove_ads]="https://kelee.one/Tool/Loon/Lpx/SeasunJX3_remove_ads.lpx"
            [Keep_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Keep_remove_ads.lpx"
            [123NetWorkDisk_remove_ads]="https://kelee.one/Tool/Loon/Lpx/123NetWorkDisk_remove_ads.lpx"
            [YoudaoTrans_remove_ads]="https://kelee.one/Tool/Loon/Lpx/YoudaoTrans_remove_ads.lpx"
            [MeituMYXJ_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MeituMYXJ_remove_ads.lpx"
            [YY_Voice_remove_ads]="https://kelee.one/Tool/Loon/Lpx/YY_Voice_remove_ads.lpx"
            [SF-Express_remove_ads]="https://kelee.one/Tool/Loon/Lpx/SF-Express_remove_ads.lpx"
            [91160_remove_ads]="https://kelee.one/Tool/Loon/Lpx/91160_remove_ads.lpx"
            [NetEaseGodlike_remove_ads]="https://kelee.one/Tool/Loon/Lpx/NetEaseGodlike_remove_ads.lpx"
            [SodaMusic_remove_ads]="https://kelee.one/Tool/Loon/Lpx/SodaMusic_remove_ads.lpx"
            [KuaiDi100_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KuaiDi100_remove_ads.lpx"
            [ChengFenMiao_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ChengFenMiao_remove_ads.lpx"
            [FC_Box_remove_ads]="https://kelee.one/Tool/Loon/Lpx/FC_Box_remove_ads.lpx"
            [KGRing_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KGRing_remove_ads.lpx"
            [ZongHeng_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ZongHeng_remove_ads.lpx"
            [51Job_remove_ads]="https://kelee.one/Tool/Loon/Lpx/51Job_remove_ads.lpx"
            [MeetYou_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MeetYou_remove_ads.lpx"
            [Yueyou_remove_ads]="https://kelee.one/Tool/Loon/Lpx/Yueyou_remove_ads.lpx"
            [MaFengWo_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MaFengWo_remove_ads.lpx"
            [OraySunlogin_remove_ads]="https://kelee.one/Tool/Loon/Lpx/OraySunlogin_remove_ads.lpx"
            [BaiduPhoto_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BaiduPhoto_remove_ads.lpx"
            [KuaiDuiZuoYe_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KuaiDuiZuoYe_remove_ads.lpx"
            [EtouchEcalendar_remove_ads]="https://kelee.one/Tool/Loon/Lpx/EtouchEcalendar_remove_ads.lpx"
            [BitqiuPan_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BitqiuPan_remove_ads.lpx"
            [MojiWeather_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MojiWeather_remove_ads.lpx"
            [MeiShiJie_remove_ads]="https://kelee.one/Tool/Loon/Lpx/MeiShiJie_remove_ads.lpx"
            [XiaChuFang_remove_ads]="https://kelee.one/Tool/Loon/Lpx/XiaChuFang_remove_ads.lpx"
            [KwaiVideoeditor_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KwaiVideoeditor_remove_ads.lpx"
            [LuckinCoffee_remove_ads]="https://kelee.one/Tool/Loon/Lpx/LuckinCoffee_remove_ads.lpx"
            [QtingFM_remove_ads]="https://kelee.one/Tool/Loon/Lpx/QtingFM_remove_ads.lpx"
            [UnionPay_remove_ads_with_ssl_unpinning]="https://kelee.one/Tool/Loon/Lpx/UnionPay_remove_ads_with_ssl_unpinning.lpx"
            [DouBan_remove_ads]="https://kelee.one/Tool/Loon/Lpx/DouBan_remove_ads.lpx"
            [BaiduMap_remove_ads]="https://kelee.one/Tool/Loon/Lpx/BaiduMap_remove_ads.lpx"
            [FC_Box_remove_ads]="https://kelee.one/Tool/Loon/Lpx/FC_Box_remove_ads.lpx"
            [ZhiLianZhaoPin_remove_ads]="https://kelee.one/Tool/Loon/Lpx/ZhiLianZhaoPin_remove_ads.lpx"
            [LoonGallery]="https://kelee.one/Tool/Loon/Lpx/LoonGallery.lpx"
            [Sub-Store]="https://kelee.one/Tool/Loon/Lpx/Sub-Store.lpx"
            [Google]="https://kelee.one/Tool/Loon/Lpx/Google.lpx"
            [1.1.1.1]="https://kelee.one/Tool/Loon/Lpx/1.1.1.1.lpx"
            [BoxJs]="https://kelee.one/Tool/Loon/Lpx/BoxJs.lpx"
            [WARP_Node_Query]="https://kelee.one/Tool/Loon/Lpx/WARP_Node_Query.lpx"
            [JD_Price]="https://kelee.one/Tool/Loon/Lpx/JD_Price.lpx"
            [YouTubeSubtitlesTranslation]="https://kelee.one/Tool/Loon/Lpx/YouTubeSubtitlesTranslation.lpx"
            [Auto_Join_TF]="https://kelee.one/Tool/Loon/Lpx/Auto_Join_TF.lpx"
            [VVebo_repair]="https://kelee.one/Tool/Loon/Lpx/VVebo_repair.lpx"
            [TestFlightRegionUnlock]="https://kelee.one/Tool/Loon/Lpx/TestFlightRegionUnlock.lpx"
            [Switch_github_mirror]="https://kelee.one/Tool/Loon/Lpx/Switch_github_mirror.lpx"
            [Node_detection_tool]="https://kelee.one/Tool/Loon/Lpx/Node_detection_tool.lpx"
            [QQ_Redirect]="https://kelee.one/Tool/Loon/Lpx/QQ_Redirect.lpx"
            [Fileball_mount]="https://kelee.one/Tool/Loon/Lpx/Fileball_mount.lpx"
            [Block_HTTPDNS]="https://kelee.one/Tool/Loon/Lpx/Block_HTTPDNS.lpx"
            [Weixin_external_links_unlock]="https://kelee.one/Tool/Loon/Lpx/Weixin_external_links_unlock.lpx"
            [TikTok_redirectn]="https://kelee.one/Tool/Loon/Lpx/TikTok_redirect.lpx"
            [Spotify_lyrics_translation]="https://kelee.one/Tool/Loon/Lpx/Spotify_lyrics_translation.lpx"
            [NodeLinkCheck]="https://kelee.one/Tool/Loon/Lpx/NodeLinkCheck.Lpx"
            [QuickSearchn]="https://kelee.one/Tool/Loon/Lpx/QuickSearch.lpx"
            [UnnooQuan_remove_watermark]="https://kelee.one/Tool/Loon/Lpx/UnnooQuan_remove_watermark.lpx"
            [AppleWeatherEnhancer]="https://kelee.one/Tool/Loon/Lpx/AppleWeatherEnhancer.lpx"
            [WPS_checkin]="https://kelee.one/Tool/Loon/Lpx/WPS_checkin.lpx"
            [FollowRSS_checkin]="https://kelee.one/Tool/Loon/Lpx/FollowRSS_checkin.lpx"
            [KebidaDushu_remove_ads]="https://kelee.one/Tool/Loon/Lpx/KebidaDushu_remove_ads.lpx"

        )
        
        # 下载插件并在文件中添加原链接
        for plugin_name in "${!plugins[@]}"; do
            url="${plugins[$plugin_name]}"
            curl -A "Surge iOS/3367" -L -o "Resources-repo/Loon/Plugin/${plugin_name}.plugin" "$url"
            
            # 将原链接添加到文件开头
           # echo "# 原链接 : $url" | cat - "Tool-repo/Loon/Plugin/Kelee/$plugin_name.plugin" > temp && mv temp "Tool-repo/Loon/Plugin/Kelee/$plugin_name.plugin"
            sed -i "1s|^|# 原链接 : $url\n|" "Resources-repo/Loon/Plugin/$plugin_name.plugin"  # 在文件开头添加原链接
        done

        # 删除 error.log 文件
        # rm -f Tool-repo/Loon/Plugin/Kelee/error.log || echo "No error log to delete"


    - name: 提取链接
      run: |
        # 确保目标目录存在
        mkdir -p Script
    
        # 切换到 Kelee 目录
        cd Resources-repo/Loon/Plugin
    
        # 遍历 .plugin 文件并提取 .js 链接
        for file in *.plugin; do
          if [ -f "$file" ]; then
            # 提取链接
            grep -o 'https://kelee\.one/Resource/Script/[^ ]*\.js' "$file" | while read -r script_url; do
              script_name=$(basename "$script_url")
    
              # 确保下载目录存在
              if [ ! -d "Script" ]; then
                echo "目标目录不存在，创建目录..."
                mkdir -p Script
              fi

              # 使用 curl 下载脚本
              curl -A "Surge iOS/3367" -L -o "Script/$script_name" "$script_url" || echo "Failed to download $script_url" >> error.log
            done
          fi
        done

    - name: 编辑LOON模块
      run: |
        mkdir -p Resources-repo/Loon/Plugin
        cd Resources-repo/Loon/Plugin  # 进入 Plugin 目录
        for file in *.plugin; do
          if [ "$file" ] ; then

            # 修改以 .js 结尾的脚本链接，删除一个文件夹部分
            sed -i 's|https://kelee\.one/Resource/Script/.*/\([^/]*\.js\)|https://github.com/Moli-X/Tool/raw/X/Loon/Plugin/Script/\1|' "$file"

            # 修改 #!homepage 行（处理等号前可能有空格的情况）
            sed -i 's|#!homepage\s*=\s*.*|#!homepage=https://github.com/Moli-X/Tool/raw/X/Loon/Plugin/'"$file"'|g' "$file"

            # 直接修改 #!openUrl 或 #!openurl 为 #App链接
            sed -i 's|^#!open[uU]rl\s*=\s*\(.*\)|#App链接=\1|' "$file"

            # 判断是否有 []，如果有就替换最后一个 []，否则直接添加
            sed -i '/^#!author/{
            # 如果没有 []，在末尾添加新的链接
            /^[^[]*$/ s|\(#!author\s*=\s*[^,]*\)$|\1[https://github.com/Moli-X/Tool/blob/X/Loon/Readme.md]|
            # 如果有 []，替换最后一个 [] 内容
            s|\(#!author\s*=\s*.*\)\[\([^]]*\)\]|\1[https://github.com/Moli-X/Tool/blob/X/Loon/Readme.md]|
            # 如果有多个作者，只替换最后一个作者的 [] 或者加到末尾
            s|\(#!author\s*=\s*.*\),\([^,]*\)\[\([^]]*\)\]|\1,\2[https://github.com/Moli-X/Tool/blob/X/Loon/Readme.md]|
            }' "$file"

          fi
        done

    # - name: 单独复刻loon配置
      # run: |
        # mkdir -p Tool/Loon
        # curl -L -o Tool-repo/Loon/Loon.conf "https://github.com/Moli-X/Resources/raw/main/Loon/Loon.conf"


###### Clash

    - name: Clash规则
      run: |
        rm -rf Resources-repo/Ruleset
        for file in Resources-repo/Clash/Rules/*.list; do
          if [ -f "$file" ]; then
            sed -i -e '/^USER-AGENT/d' "$file"
            sed -i -e '/^URL-REGEX/d' "$file"
            file_names=$(basename "$file" .list)
            line_count=$(wc -l < "$file")
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            sed -i '2a\\' "$file"
          else
            echo "$file not found."
          fi
        done

    - name: 复刻Meta覆写
      run: |
        mkdir -p Resources-repo/Clash/Meta

        curl -L -o Resources-repo/Clash/Meta/Override.js "https://github.com/Repcz/Tool/raw/X/Clash/Meta/Override.js"
        curl -L -o Resources-repo/Clash/Meta/MihomoParty.js "https://github.com/Moli-X/Resources/raw/main/Clash/Script/MihomoParty.js"
        curl -L -o Resources-repo/Clash/Meta/MihomoParty.yaml "https://github.com/Moli-X/Resources/raw/main/Clash/MihomoParty.yaml"

###### QuantumultX

    - name: QuantumultX规则
      run: |
        for file in Resources-repo/QuantumultX/Rules/*.list; do
          if [ -f "$file" ]; then
            sed -i -e '/^PROCESS-NAME/d' "$file"
            sed -i -e '/^AND/d' "$file"
            sed -i -e '/^OR/d' "$file"
            sed -i -e '/^NOT/d' "$file"
            sed -i -e '/^DEST-PORT/d' "$file"
            sed -i -e 's/^DOMAIN,/HOST,/g' "$file"
            sed -i -e 's/^DOMAIN-SUFFIX,/HOST-SUFFIX,/g' "$file"
            sed -i -e 's/^DOMAIN-KEYWORD,/HOST-KEYWORD,/g' "$file"
            sed -i -e 's/^DOMAIN-WILDCARD,/HOST-WILDCARD,/g' "$file"
            sed -i -e 's/^IP-CIDR6,/IP6-CIDR,/g' "$file"
            sed -i 's/,no-resolve//g' "$file"
          else
            echo "$file not found."
          fi
        done

        for file in Resources-repo/QuantumultX/Rules/*.list; do
          if [ -f "$file" ]; then
            file_names=$(basename "$file" .list)
            line_count=$(wc -l < "$file")
            awk -v policy="$file_names" '!/^#|^ *$/ {print $0","policy; next} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            sed -i '2a\\' "$file"
          else
            echo "$file not found."
          fi
        done


    # - name: 单独复刻QX配置
      # run: |
        # mkdir -p Resources/QuantumultX
        # curl -L -o Resources-repo/QuantumultX/QuantumultX.conf "https://github.com/GodMoli/QuanX/raw/main/File/Auto.conf"

###### Surge

    - name: Surge规则
      run: |
        for file in Resources-repo/Surge/Rules/*.list; do
          if [ -f "$file" ]; then
            file_names=$(basename "$file" .list)
            line_count=$(wc -l < "$file")
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            sed -i '2a\\' "$file"
          else
            echo "$file not found."
          fi
        done

    # - name: 单独复刻Surge配置
      # run: |
        # mkdir -p Resources/Surge
        # curl -L -o Resources-repo/Surge/SurgePRO.conf "https://github.com/Moli-X/Resources/raw/main/Surge/SurgePRO.conf"

###### Shadowrocket

    - name: Shadowrocket规则
      run: |
        for file in Resources-repo/Shadowrocket/Rules/*.list; do
          if [ -f "$file" ]; then
            sed -i -e '/^PROCESS-NAME/d' "$file"
            file_names=$(basename "$file" .list)
            line_count=$(wc -l < "$file")
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            sed -i '2a\\' "$file"
          else
            echo "$file not found."
          fi
        done

    # - name: 单独复刻Shadowrocket配置
      # run: |
        # mkdir -p Resources/Shadowrocket
        # curl -L -o Resources-repo/Shadowrocket/Shadowrocket.conf "https://raw.githubusercontent.com/Moli-X/Shadowrocket/Master/Rewite/Shadowrocket.conf"



###### Stash

    - name: Stash规则
      run: |
        for file in Resources-repo/Stash/Rules/*.list; do
          if [ -f "$file" ]; then
            sed -i -e '/^USER-AGENT/d' "$file"
            sed -i -e '/^URL-REGEX/d' "$file"
            sed -i -e '/^AND/d' "$file"
            sed -i -e '/^OR/d' "$file"
            sed -i -e '/^NOT/d' "$file"
            file_names=$(basename "$file" .list)
            line_count=$(wc -l < "$file")
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            sed -i -E '/^(OR|AND|NOT|USER-AGENT|URL-REGEX),/ s/^/#/' "$file"
            sed -i '2a\\' "$file"
          else
            echo "$file not found."
          fi
        done

##### Egern       
    - name: Egern规则
      run: |
        # 确保目标目录存在
        mkdir -p Resources-repo/Egern/Rules
        cd Resources-repo/Egern/Rules
        # 遍历Resources-repo/Egern/Rules目录下的所有.yaml文件
        for file in Resources-repo/Egern/Rules/*.yaml; do
          # 如果文件存在
          if [ -f "$file" ]; then
            # 删除文件中的USER-AGENT、PROCESS-NAME、DEST-PORT行
            sed -i -e '/^USER-AGENT/d' "$file"
            sed -i -e '/^PROCESS-NAME/d' "$file"
            sed -i -e '/^DEST-PORT/d' "$file"
            # 将DOMAIN, DOMAIN-SUFFIX, DOMAIN-KEYWORD, IP-CIDR, IP-CIDR6, IP-ASN, URL-REGEX, GEOIP行前添加domain_set:, domain_suffix_set:, domain_keyword_set:, ip_cidr_set:, ip_cidr6_set:, asn_set:, url_regex_set:, geoip_set:
            awk '/^DOMAIN,/ && !added {print "domain_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^DOMAIN-SUFFIX,/ && !added {print "domain_suffix_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^DOMAIN-KEYWORD,/ && !added {print "domain_keyword_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^IP-CIDR,/ && !added {print "ip_cidr_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^IP-CIDR6,/ && !added {print "ip_cidr6_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^IP-ASN,/ && !added {print "asn_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^URL-REGEX,/ && !added {print "url_regex_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
            awk '/^GEOIP,/ && !added {print "geoip_set:"; added=1} {print}' "$file" > tmpfile && mv tmpfile "$file"
          else
            # 如果文件不存在，输出提示信息
            echo "$file not found."
          fi
        done

        # 遍历Tool-repo/Egern/Rules目录下的所有.yaml文件
        for file in Resources-repo/Egern/Rules/*.yaml; do
          # 如果文件存在
          if [ -f "$file" ]; then
            # 如果文件中存在IP-ASN、IP-CIDR、IP-CIDR6行，在文件开头添加o_resolve: true
            if grep -qE '^IP-(ASN|CIDR|CIDR6).*no-resolve$' "$file"; then
            sed -i '1i\no_resolve: true' "$file"
            fi
            # 将URL-REGEX行中的第二个逗号后的内容加上双引号
            sed -i -E 's/^(URL-REGEX,)([^,]+)$/\1"\2"/' "$file"
            # 将DOMAIN、DOMAIN-SUFFIX、DOMAIN-KEYWORD、IP-CIDR、IP-CIDR6、IP-ASN、URL-REGEX、GEOIP行前添加  -
            sed -i -E 's/^(DOMAIN|DOMAIN-SUFFIX|DOMAIN-KEYWORD|IP-CIDR|IP-CIDR6|IP-ASN|URL-REGEX|GEOIP),/  - /g' "$file"
            # 删除文件中的no-resolve
            sed -i 's/,no-resolve//g' "$file"
            # 获取文件名
            file_names=$(basename "$file" .yaml)
            # 获取文件中的行数
            line_count=$(grep -c '^  - ' "$file")
            # 在文件开头添加规则名称
            awk -v fname="$file_names" 'NR==1 {print "# 规则名称: " fname} {print}' "$file" > tmpfile && mv tmpfile "$file"
            # 在文件开头添加规则统计
            awk -v count="$line_count" 'NR==2 {print "# 规则统计: " count} {print}' "$file" > tmpfile && mv tmpfile "$file"
            # 在文件开头添加空行
            sed -i '2a\\' "$file"
          else
            # 如果文件不存在，输出提示信息
            echo "$file not found."
          fi
        done



###### GeoIP

    - name: 复刻GeoIP规则
      run: |
        mkdir -p Resources/GeoIP
        curl -L -o Resources-repo/GeoIP/CN_Country.mmdb "https://github.com/Hackl0us/GeoIP2-CN/raw/release/Country.mmdb"
        curl -L -o Resources-repo/GeoIP/Global_Country.mmdb "https://raw.githubusercontent.com/Loyalsoldier/geoip/release/Country.mmdb"
        curl -L -o Resources-repo/GeoIP/geoip-lite.dat "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip-lite.dat"
        curl -L -o Resources-repo/GeoIP/geosite.dat "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat"
        curl -L -o Resources-repo/GeoIP/country-lite.mmdb "https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country-lite.mmdb"
        curl -L -o Resources-repo/GeoIP/GeoLite2-ASN.mmdb "https://github.com/xishang0128/geoip/releases/download/latest/GeoLite2-ASN.mmdb"




# ###### 可莉README
    # - name: 提取并添加表格内容
      # run: |

        # # 创建或清空目标 README 文件
        # mkdir -p Tool/Loon
        # echo '' > Tool-repo/Loon/Readme.md
        
        # # 添加 Resources 部分
        # echo '### Resources' >> Tool-repo/Loon/Readme.md
        # echo '<a href="https://t.me/GodMoliibot"><img src="https://raw.githubusercontent.com/Moli-X/Resources/main/Icon/Image/Hello.gif" width="20%" height="20%"></a>' >> Tool-repo/Loon/Readme.md
        # echo '' >> Tool-repo/Loon/Readme.md
        # echo 'TG Channel：https://t.me/QuantX' >> Tool-repo/Loon/Readme.md
        # echo '' >> Tool-repo/Loon/Readme.md
        # echo '## Loon脚本收集: [欢迎投稿](https://t.me/Skill_XX )' >> Tool-repo/Loon/Readme.md
    
        # # 提取并添加表格内容
        # curl -s https://raw.githubusercontent.com/luestr/ProxyResource/main/README.md | \
        # sed -n '/<table>/,/<\/table>/p' >> Tool-repo/Loon/Readme.md
    
        # # 替换 Plugin 部分
        # sed -i 's|https://kelee.one/Tool/Loon/Plugin|https://github.com/Moli-X/Tool/raw/X/Loon/Plugin/Kelee|g' Tool-repo/Loon/Readme.md

    
    
       
###### Commit
    - name: 添加Commits
      run: |
        cd Resources-repo
        if [[ -n $(git status -s) ]]; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Update $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M')"
          git push origin HEAD
        else
          echo "No changes to commit."
        fi


    - name: 清理Workflow
      uses: Mattraks/delete-workflow-runs@main
      with:
        token: ${{ secrets.GITHUB_TOKEN }} 
        retain_days: 0
        keep_minimum_runs: 2
